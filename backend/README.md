# PM Letter Backend

이 디렉터리는 FastAPI 기반의 PM Letter 구독 API와 Railway/Supabase 환경 구성을 포함합니다.

## 1. 환경 변수 설정

`.env` 또는 Railway 프로젝트 변수로 아래 값을 정의하세요.

| 변수 | 설명 |
| --- | --- |
| `SUPABASE_URL` | Supabase 프로젝트 URL (`https://*.supabase.co`) |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase service role key (행 단위 보안 우회를 위해 필요) |
| `SUPABASE_ANON_KEY` | 선택: 클라이언트에서 직접 Supabase를 사용할 때 필요 |
| `ALLOWED_ORIGINS` | 선택: CORS 허용 오리진. 콤마로 구분된 목록 (예: `https://pm-letter.kr,https://www.pm-letter.kr`) |
| `MAILIE_API_BASE_URL` | 메일리 API 기본 URL (`https://api.mailie.io` 등) |
| `MAILIE_API_KEY` | 메일리 API 인증 토큰 |

## 2. Supabase 테이블 생성

Supabase SQL Editor에서 아래 스키마를 실행하세요.

```sql
create table if not exists public.subscriptions (
    id bigint generated by default as identity primary key,
    email text not null unique,
    progress_day smallint not null default 0,
    last_sent_at timestamptz,
    subscribed_at timestamptz not null default timezone('utc', now())
);
```

## 3. 로컬 실행

```bash
cd backend
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload
```

## 4. Railway 배포

1. Railway에서 **New Project → Deploy from GitHub Repo**로 이 저장소를 연결합니다.
2. `backend` 디렉터리를 서비스 루트로 사용하도록 `Procfile` 없이도, Railway의 "Start Command"에 `uvicorn app.main:app --host 0.0.0.0 --port $PORT`를 입력하세요.
3. `pip install -r backend/requirements.txt`를 실행하도록 Nixpacks 자동 감지를 사용하거나, `railway run` 시 `PYTHONPATH=backend` 환경을 추가하세요. (Railway는 하위 디렉터리에 있는 경우 `NIXPACKS_BUILD_CMD=pip install -r backend/requirements.txt`와 `NIXPACKS_START_CMD=uvicorn app.main:app --host 0.0.0.0 --port $PORT` 설정을 추천합니다.)
4. 위 표의 환경 변수를 Railway Variables로 추가합니다.

## 5. Railway Cron (매일 자정)

Railway의 **Cron Jobs** 기능을 사용해 아래 설정으로 작업을 추가하세요.

- Schedule: `0 0 * * *` (UTC 기준 자정. KST 자정을 원하면 `0 15 * * *` 사용)
- Command: `python -m tasks.daily_progress_job`
- Working directory: `backend`
- Variables: API 서비스와 동일한 환경 변수를 재사용합니다.

Cron 작업은 Supabase에서 `progress_day < 5`인 레코드를 조회해 메일리 API에 `course_day`를 전달한 후, 성공 시 `progress_day`를 +1 하고 `last_sent_at`을 현재 시각으로 업데이트합니다.

## 6. 프론트엔드 연동

`index.html` 폼 제출 시 `POST /subscriptions`로 이메일을 전송하며, 성공/실패에 따라 토스트 메시지를 보여줍니다. Railway에서 배포한 API URL을 스크립트 상단의 `API_BASE_URL` 상수에 설정하세요.

## 7. 헬스체크

Railway 서비스의 Health Check URL로 `/health` 엔드포인트를 지정하면 배포 상태를 확인할 수 있습니다.
